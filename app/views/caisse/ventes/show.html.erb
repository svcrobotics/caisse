<div class="max-w-4xl mx-auto bg-white shadow rounded p-6">
  <h1 class="text-2xl font-bold mb-4">üßæ D√©tail de la vente n¬∞<%= @vente.id %></h1>

  <% if @vente.annulee? %>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      <p class="font-bold">‚ö†Ô∏è Vente annul√©e</p>
      <p class="italic text-sm mt-1">Motif : <%= @vente.motif_annulation.presence || "Non pr√©cis√©" %></p>
    </div>
  <% end %>

  <% if @avoir_utilise.present? %>
    <div class="bg-yellow-100 text-yellow-900 px-4 py-2 rounded mb-2">
      <span>üí≥ <strong>Avoir utilis√©</strong>‚ÄØ: 
        <%= link_to "N¬∞#{@avoir_utilise.id}", main_app.avoir_path(@avoir_utilise) %> ‚Äî 
        <%= number_to_currency(@avoir_utilise.montant) %>
      </span>
      <% if @reste < 0 %>
        <span class="block text-xs text-gray-700 mt-1">
          Le total √©tait couvert par l‚Äôavoir.
        </span>
      <% end %>
    </div>
  <% end %>

  <% if @avoir_emis.present? %>
    <div class="bg-green-100 text-green-900 px-4 py-2 rounded mb-2">
      <span>üü¢ <strong>Nouvel avoir √©mis</strong>‚ÄØ: 
        <%= link_to "N¬∞#{@avoir_emis.id}", main_app.avoir_path(@avoir_emis) %> ‚Äî 
        <%= number_to_currency(@avoir_emis.montant) %>
      </span>
      <span class="block text-xs text-gray-700 mt-1">
        Cet avoir pourra √™tre utilis√© sur une prochaine vente.
      </span>
    </div>
  <% end %>

  <div class="mb-4 text-gray-700">
    <p><strong>ID Vente :</strong> <%= @vente.id %></p>
    <p><strong>Date :</strong> <%= l(@vente.date_vente || @vente.created_at, format: :long) %></p>
    <p><strong>Cliente :</strong> <%= @vente.client&.nom || "Sans cliente" %></p>
    <p><strong>Mode de paiement :</strong>
      <%= [
        ("CB: #{number_to_currency(@vente.cb)}" if @vente.cb.to_f > 0),
        ("Esp√®ces: #{number_to_currency(@vente.espece)}" if @vente.espece.to_f > 0),
        ("Ch√®que: #{number_to_currency(@vente.cheque)}" if @vente.cheque.to_f > 0),
        ("AMEX: #{number_to_currency(@vente.amex)}" if @vente.amex.to_f > 0)
      ].compact.join(" ¬∑ ").html_safe.presence || "Non pr√©cis√©" %>
    </p>
    <p><strong>Total brut :</strong> <%= number_to_currency(@vente.total_brut) %></p>
    <p><strong>Total net (apr√®s remises) :</strong> <%= number_to_currency(@vente.total_net) %></p>
      <% if @avoir_utilise.present? %>
        <p>
          <strong>Montant d‚Äôavoir utilis√© :</strong>
          <%= number_to_currency(@avoir_utilise.montant) %>
        </p>
        <p>
          <strong>
            <% if @reste <= 0 %>
              Vente enti√®rement r√©gl√©e par avoir.
              <% if @avoir_emis.present? %>
                Un avoir de <%= number_to_currency(@avoir_emis.montant) %> a √©t√© √©mis pour la diff√©rence.
              <% end %>
            <% else %>
              Reste √† payer apr√®s avoir‚ÄØ:
              <%= number_to_currency(@reste) %>
            <% end %>
          </strong>
        </p>
      <% else %>
        <p>
          <strong>Total pay√© :</strong> <%= number_to_currency(@vente.total_net) %>
        </p>
      <% end %>
  </div>

  <h2 class="text-xl font-semibold mt-6 mb-2">üõç D√©tail des produits vendus</h2>
  <table class="w-full text-sm border-collapse rounded shadow">
    <thead class="bg-gray-100 text-gray-700 border-b">
      <tr>
        <th class="px-3 py-2 text-left">Produit</th>
        <th class="px-3 py-2 text-left">Code-barres</th>
        <th class="px-3 py-2 text-right">Qt√©</th>
        <th class="px-3 py-2 text-right">Prix unitaire</th>
        <th class="px-3 py-2 text-right">Remise</th>
        <th class="px-3 py-2 text-right">Total net</th>
        <th class="px-3 py-2 text-left">D√©posant</th>
        <th class="px-3 py-2 text-right">Prix d√©posant</th>
      </tr>
    </thead>
    <tbody>
      <% @vente.ventes_produits.includes(:produit).each do |vp| %>
        <% produit = vp.produit %>
        <% total_brut = vp.prix_unitaire * vp.quantite %>
        <% remise_pct = vp.remise.to_d %>
        <% remise_euros = (total_brut * (remise_pct / 100)).round(2) %>
        <% total_net = (total_brut - remise_euros).round(2) %>
        <tr class="border-b hover:bg-yellow-50">
          <td class="px-3 py-2 font-semibold text-gray-800">
            <%= produit.nom %>
            <span class="block text-xs text-gray-400">#<%= produit.id %></span>
          </td>
          <td class="px-3 py-2"><%= produit.code_barre %></td>
          <td class="px-3 py-2 text-right"><%= vp.quantite %></td>
          <td class="px-3 py-2 text-right whitespace-nowrap">
            <% if produit.en_promo? && produit.prix_promo.present? && produit.prix_promo.to_d != produit.prix.to_d %>
              <span class="relative inline-block text-gray-500 text-sm font-medium">
                <span class="inline-block"><%= number_to_currency(produit.prix) %></span>
                <span style="position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background-color: red; transform: rotate(-15deg); transform-origin: left center;"></span>
              </span>
              <span class="ml-2 text-red-600 font-bold text-sm">
                <%= number_to_currency(vp.prix_unitaire) %>
              </span>
            <% else %>
              <%= number_to_currency(vp.prix_unitaire) %>
            <% end %>
          </td>
          <td class="px-3 py-2 text-right">
            <% if remise_euros > 0 %>
              <span class="text-orange-700">-<%= number_to_currency(remise_euros) %> (<%= remise_pct.to_i %>%)</span>
            <% else %>
              <span class="text-gray-400">‚Äî</span>
            <% end %>
          </td>
          <td class="px-3 py-2 text-right font-bold">
            <%= number_to_currency(total_net) %>
          </td>
          <td class="px-3 py-2">
            <% if produit.client.present? %>
              <%= link_to "#{produit.client.prenom} #{produit.client.nom}", main_app.client_path(produit.client), class: "text-blue-600 hover:underline" %>
            <% else %>
              <span class="text-gray-400">‚Äî</span>
            <% end %>
          </td>
          <td class="px-3 py-2 text-right">
            <% if produit.prix_deposant.present? %>
              <%= number_to_currency(produit.prix_deposant) %>
            <% else %>
              <span class="text-gray-400">‚Äî</span>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
    <tfoot>
      <tr class="bg-gray-100 border-t">
        <td colspan="5" class="text-right font-semibold px-3 py-2">Total net produits :</td>
        <td class="text-right font-bold px-3 py-2">
          <%= number_to_currency(@vente.total_net) %>
        </td>
        <td colspan="2"></td>
      </tr>
      <% if @avoir_utilise.present? %>
        <tr class="bg-yellow-50">
          <td colspan="5" class="text-right font-semibold px-3 py-2 text-yellow-900">Avoir utilis√© :</td>
          <td class="text-right px-3 py-2 text-yellow-900">
            -<%= number_to_currency(@avoir_utilise.montant) %>
          </td>
          <td colspan="2"></td>
        </tr>
        <% if @reste <= 0 %>
          <tr class="bg-green-50">
            <td colspan="5" class="text-right font-semibold px-3 py-2 text-green-900">
              Total r√©gl√© par avoir
              <% if @avoir_emis.present? %>
                &nbsp;/ Nouvel avoir √©mis
              <% end %>
              :
            </td>
            <td class="text-right font-bold px-3 py-2 text-green-900">
              0,00&nbsp;‚Ç¨
              <% if @avoir_emis.present? %>
                <br>
                <span class="text-xs text-green-900">
                  +<%= number_to_currency(@avoir_emis.montant) %>
                </span>
              <% end %>
            </td>
            <td colspan="2"></td>
          </tr>
        <% else %>
          <tr class="bg-blue-50">
            <td colspan="5" class="text-right font-semibold px-3 py-2 text-blue-900">Reste √† payer :</td>
            <td class="text-right font-bold px-3 py-2 text-blue-900">
              <%= number_to_currency(@reste) %>
            </td>
            <td colspan="2"></td>
          </tr>
        <% end %>
      <% else %>
        <tr class="bg-blue-50">
          <td colspan="5" class="text-right font-semibold px-3 py-2 text-blue-900">Total pay√© :</td>
          <td class="text-right font-bold px-3 py-2 text-blue-900">
            <%= number_to_currency(@vente.total_net) %>
          </td>
          <td colspan="2"></td>
        </tr>
      <% end %>
    </tfoot>
  </table>


  <div class="mt-6">
    <%= link_to "‚Üê Retour √† la liste", ventes_path, class: "text-blue-600 hover:underline" %>
  </div>
</div>
