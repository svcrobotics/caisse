<div class="max-w-4xl mx-auto bg-white shadow rounded p-6 text-gray-800">

  <!-- Titre principal -->
  <h1 class="text-2xl font-bold mb-4">ğŸ§¾ DÃ©tail de la vente nÂ°<%= @vente.id %></h1>

  <!-- Alertes -->
  <% if @vente.annulee? %>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      âš ï¸ <strong>Vente annulÃ©e</strong><br>
      <span class="italic text-sm">Motif : <%= @vente.motif_annulation.presence || "Non prÃ©cisÃ©" %></span>
    </div>
  <% end %>

  <% if @avoir_utilise %>
    <div class="bg-yellow-100 text-yellow-900 px-4 py-2 rounded mb-2">
      ğŸ’³ <strong>Avoir utilisÃ©</strong> : 
      <%= link_to "NÂ°#{@avoir_utilise.id}", main_app.avoir_path(@avoir_utilise) %> â€” 
      <%= number_to_currency(@avoir_utilise.montant) %>
      <% if @reste <= 0 %>
        <span class="block text-xs mt-1">Le total Ã©tait couvert par lâ€™avoir.</span>
      <% end %>
    </div>
  <% end %>

  <% if @avoir_emis %>
    <div class="bg-green-100 text-green-900 px-4 py-2 rounded mb-2">
      ğŸŸ¢ <strong>Nouvel avoir Ã©mis</strong> : 
      <%= link_to "NÂ°#{@avoir_emis.id}", main_app.avoir_path(@avoir_emis) %> â€” 
      <%= number_to_currency(@avoir_emis.montant) %>
      <span class="block text-xs mt-1">Cet avoir pourra Ãªtre utilisÃ© sur une prochaine vente.</span>
    </div>
  <% end %>

  <!-- Infos gÃ©nÃ©rales -->
  <div class="mb-6 space-y-1">
    <p><strong>Date :</strong> <%= l(@vente.date_vente || @vente.created_at, format: :long) %></p>
    <p><strong>Cliente :</strong> <%= @vente.client&.nom || "Sans cliente" %></p>
    
    <p><strong>Total brut :</strong> <%= number_to_currency(@vente.total_brut) %></p>

    <% total_remises_produits = @vente.ventes_produits.sum do |vp| 
       total_ligne = vp.prix_unitaire * vp.quantite
       (total_ligne * (vp.remise.to_d / 100)).round(2)
    end %>

    <p><strong>Remises produits :</strong> -<%= number_to_currency(total_remises_produits) %></p>

    <% if @vente.remise_globale.to_f > 0 %>
      <p><strong>Remise globale :</strong> -<%= number_to_currency(@vente.remise_globale) %></p>
    <% end %>
    <% if @avoir_utilise %>
      <p><strong>Montant dâ€™avoir utilisÃ© :</strong> <%= number_to_currency(@avoir_utilise.montant) %></p>
      <% if @reste > 0 %>
        <p><strong>Reste Ã  payer aprÃ¨s avoir :</strong> <%= number_to_currency(@reste) %></p>
      <% elsif @avoir_emis %>
        <p><strong>Vente entiÃ¨rement rÃ©glÃ©e</strong>. Un avoir de <%= number_to_currency(@avoir_emis.montant) %> a Ã©tÃ© Ã©mis pour la diffÃ©rence.</p>
      <% end %>
    <% else %>
      <% total_remises = total_remises_produits + @vente.remise_globale %>
      <p><strong>Total remises :</strong> -<%= number_to_currency(total_remises) %></p>
      <p><strong>Total net (aprÃ¨s remises) :</strong> <%= number_to_currency(@vente.total_net) %></p>
      <p><strong>Total payÃ© :</strong> <%= number_to_currency(@vente.total_net) %></p>
    <% end %>
    <p><strong>Mode de paiement :</strong> 
      <%= [
            ("CB: #{number_to_currency(@vente.cb)}" if @vente.cb.to_f > 0),
            ("EspÃ¨ces: #{number_to_currency(@vente.espece)}" if @vente.espece.to_f > 0),
            ("ChÃ¨que: #{number_to_currency(@vente.cheque)}" if @vente.cheque.to_f > 0),
            ("AMEX: #{number_to_currency(@vente.amex)}" if @vente.amex.to_f > 0)
          ].compact.join(" Â· ").html_safe.presence || "Non prÃ©cisÃ©" %>
    </p>
  </div>

  <% total_net_avant_remise_globale = @vente.ventes_produits.sum do |vp|
     total_brut = vp.prix_unitaire * vp.quantite
     remise_euros = (total_brut * (vp.remise.to_d / 100)).round(2)
     (total_brut - remise_euros).round(2)
  end %>

  <h2 class="text-xl font-semibold mt-6 mb-3">ğŸ› Produits vendus</h2>
  <table class="w-full text-sm border-collapse rounded shadow">
    <thead class="bg-gray-100 text-gray-700 border-b">
      <tr>
        <th class="px-3 py-2 text-left">Produit</th>
        <th class="px-3 py-2 text-left">Code-barre</th>
        <th class="px-3 py-2 text-right">QtÃ©</th>
        <th class="px-3 py-2 text-right">Prix unitaire</th>
        <th class="px-3 py-2 text-right">Remise</th>
        <th class="px-3 py-2 text-right">Total net</th>
        <th class="px-3 py-2 text-left">DÃ©posant</th>
        <th class="px-3 py-2 text-right">Action</th>
      </tr>
    </thead>
    <tbody>
      <% @vente.ventes_produits.includes(:produit).each do |vp| %>
        <% produit = vp.produit %>
        <% total_brut = vp.prix_unitaire * vp.quantite %>
        <% remise_euros = (total_brut * (vp.remise.to_d / 100)).round(2) %>
        <% total_net = (total_brut - remise_euros).round(2) %>

        <% prorata_remise_globale = if @vente.remise_globale.to_f > 0 && total_net_avant_remise_globale > 0
          (@vente.remise_globale.to_f * total_net / total_net_avant_remise_globale).round(2)
        else
          0
        end %>

        <% total_net_final = (total_net - prorata_remise_globale).round(2) %>

        <tr class="border-b hover:bg-yellow-50">
          <td class="px-3 py-2 font-semibold">
            <%= produit.nom %><br>
            <span class="text-xs text-gray-400">#<%= produit.fournisseur&.nom || "--" %></span>
          </td>
          <td class="px-3 py-2"><%= produit.code_barre %></td>
          <td class="px-3 py-2 text-right"><%= vp.quantite %></td>
          <td class="px-3 py-2 text-right"><%= number_to_currency(vp.prix_unitaire) %></td>
          <td class="px-3 py-2 text-right">
            <% if remise_euros > 0 %>
              <div class="text-orange-700">-<%= number_to_currency(remise_euros) %> (<%= vp.remise.to_i %>%)</div>
            <% end %>
            <% if prorata_remise_globale > 0 %>
              <div class="text-blue-700 text-xs italic">-<%= number_to_currency(prorata_remise_globale) %> (prorata globale)</div>
            <% end %>
            <% if remise_euros == 0 && prorata_remise_globale == 0 %>
              <span class="text-gray-400">â€”</span>
            <% end %>
          </td>
          <td class="px-3 py-2 text-right font-bold"><%= number_to_currency(total_net_final) %></td>
          <td class="px-3 py-2">
            <% if produit.client %>
              <%= link_to produit.client.nom, main_app.client_path(produit.client), class: "text-blue-600 hover:underline" %>
            <% else %>
              <span class="text-gray-400">â€”</span>
            <% end %>
          </td>
          <td class="px-3 py-2 text-right">
            <% if produit.etat == "neuf" %>
              <%= button_to "ğŸ’¸ Remboursement", rembourser_produit_vente_path(@vente, produit_id: produit.id), method: :post, params: { quantite: 1 }, data: { turbo_confirm: "Rembourser 1 exemplaire ?" }, class: "text-red-600 text-sm" %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>


  <!-- Bouton retour -->
  <div class="mt-6">
    <%= link_to "â† Retour Ã  la liste", ventes_path, class: "text-blue-600 hover:underline" %>
  </div>
</div>
